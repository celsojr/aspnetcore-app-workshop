# Construindo um Front End SPA

Nesta sessão, nós iremos adicionar o código para o aplicativo cliente. Crie uma *view* para as sessões da conferência, detalhes e informações do palestrante.

>Este exemplo usa os modelos SpaServices que combinam o FrontEnd e a API da Web por padrão. Neste laboratório/amostra de código, a API (BackEnd) é um projeto separado, portanto, partes desnecessárias do código gerado podem ser removidas e a configuração do URL da API será tratada de uma maneira mais adequada a uma configuração de produção.

> *Nota:* Ele usa o modelo 2.0 para SPA o qual não está incluido no SDK do .NET Core 2.0.x. Se você está em um desses SDKs você vai precisar seguir essas instruções [aqui](https://docs.microsoft.com/en-us/aspnet/core/spa/index?view=aspnetcore-2.1#installation) para obter novos modelos

## Criando o projeto

Crie a nova aplicação usando o CLI do `dotnet` na pasta **ConferencePlanner**.

```bash
dotnet new angular -n FrontEndSpa -o src/FrontEndSpa
```

Adicione um novo projeto na solução

```bash
dotnet sln add src/FrontEnd/FrontEnd.csproj
```

### Limpar

Como a API é um projeto separado, é possível fazer algumas configurações iniciais e limpar os arquivos desnecessários.

#### Remover o componente Weather

- delete a pasta **Controllers**
- delete a pasta **ClientApp/src/app/fetch-data**
- remova todas as referências (linha inteira) do **FetchDataComponent** no **ClientApp/src/app/app.module.ts**
- remova o link do **nav-menu.component.html**

```html
<li [routerLinkActive]='["link-active"]' [routerLinkActiveOptions]='{ exact: true }'>
    <a [routerLink]='["/"]' (click)='collapse()'>
    <span class='glyphicon glyphicon-home'></span> Counter
  </a>
</li>
```

### Remova o componente Counter

- delete a pasta **ClientApp/src/app/counter**
- remova todas as referências (linha inteira) do **CounterComponent** no **ClientApp/src/app/app.module.ts**
- remova o link do **nav-menu.component.html**

```html
<li [routerLinkActive]='["link-active"]'>
  <a [routerLink]='["/counter"]' (click)='collapse()'>
    <span class='glyphicon glyphicon-education'></span> Counter
  </a>
</li>
```

## Configure a URL para o serviço de Web API

A URL para o serviço ASP.NET Core Web API precisa ser definido como uma configuração. Depois, faz sentido ter a capacidade de usar diferentes configurações por ambiente. Angular usa os arquivos **environments* para isso.

Abra o **ClientApp/src/environments/environments.ts** e altere-o como a seguir:

```javascript
export const environment = {
  production: false,
  API_URL: 'http://localhost:50069'
};
```

Para um configuração de produção, adicione o valor `API_URL` no arquivo **environment.prod.ts** também.

Abra o **ClientApp/src/main.ts**, adicione a função `getApiUrl()` e adicione o novo `API_URL` para os provedores

```javascript
export function getApiUrl() {
  return environment.API_URL;
}

const providers = [
  { provide: 'BASE_URL', useFactory: getBaseUrl, deps: [] },
  { provide: 'API_URL', useFactory: getApiUrl, deps: [] }
];
```

## Crie e levante a API usando um Serviço Angular

> Nós iremos criar os modelos para mapear as classes ConferenceDTO e um classe para falar com o serviço ASP.NET Core Web API

### Crie o modelo

Usando a CLI do Angular, crie a classe para o modelo para mapear as classes ConferenceDTO para as classes TypeScript. Mude o diretório para ClientApp e crie um **model.ts** usando o seguinte comando.

```bash
ng g class shared/model
```

Adicione o seguinte código no arquivo.

```javascript
  export class Track {
    trackID: number;
    conferenceID: number;
    name: string;
  }

  export class Speaker {
    id: number;
    name: string;
    bio?: any;
    webSite?: any;
    sessions?: Session[];
  }

  export class Session {
    track: Track;
    speakers: Speaker[];
    tags: any[];
    id: number;
    conferenceID: number;
    title: string;
    abstract: string;
    startTime: Date;
    endTime: Date;
    duration: string;
    trackId: number;
  }
```

### Crie o serviço de dados

Crie o serviço de dados para chamar a ASP.NET Core Web API.

```bash
ng g service shared/data
```

Atualize o código para o seguinte.

```javascript
import { Injectable, Inject } from '@angular/core';
import { Headers, Http } from '@angular/http';

import 'rxjs/add/operator/toPromise';

import { Session, Speaker } from './model';

@Injectable()
export class DataService {

  private headers = new Headers({ 'Content-Type': 'application/json' });
  private sessionUrl = 'api/sessions';
  private speakerUrl = 'api/speakers';
  /**
   * init with Http
   */
  constructor(private http: Http, @Inject('API_URL') private baseUrl: string) { }

  getSessions(): Promise<Session[]> {
    return this.http.get(this.baseUrl + this.sessionUrl)
      .toPromise()
      .then(response => <Session[]>response.json())
      .catch(this.handleError);
  }

  getSession(id: number): Promise<Session> {
    const url = `${this.baseUrl + this.sessionUrl}/${id}`;
    return this.http.get(url)
      .toPromise()
      .then(response => <Session>response.json())
      .catch(this.handleError);
  }

  getSpeaker(id: number): Promise<Speaker> {
    const url = `${this.baseUrl + this.speakerUrl}/${id}`;
    return this.http.get(url)
      .toPromise()
      .then(response => <Speaker>response.json())
      .catch(this.handleError);
  }

  getSpeakers(): Promise<Speaker[]> {
    return this.http.get(this.baseUrl + this.speakerUrl)
      .toPromise()
      .then(response => <Speaker[]>response.json())
      .catch(this.handleError);
  }

  private getData(response: Response) { }
  private handleError(error: any): Promise<any> {
    console.error('An error occurred', error); // for demo purposes only
    return Promise.reject(error.message || error);
  }
}
```

## Liste as sessões

> Agora que temos um serviço para conversar com a API, nós iremos adicionar as visualizações para exibir uma lista básica de todas as sessões da conferência e validar a comunicação FrontEnd / API.

### Crie e adicione o componente Sessions

1. Crie o componente sessions

    ```bash
    ng g component sessions
    ```

1. Atualize o arquivo **sessions.component.ts** para o seguinte

    ```typescript
    import { Component, OnInit } from '@angular/core';
    import { Router } from '@angular/router';

    import { DataService } from '../shared/data.service';
    import { Session } from '../shared/model';

    @Component({
        selector: 'conf-sessions',
        templateUrl: './sessions.component.html'
    })
    export class SessionsComponent implements OnInit {
        sessions: Session[];

        constructor(private dataService: DataService) { }

        getSessions(): void {
            this.dataService
                .getSessions()
                .then(sessions => this.sessions = sessions);
        }

        ngOnInit() {
            this.getSessions();
        }
    }
    ```

1. Atualizar o template **sessions.component.html**

    ```html
    <div class="agenda">
      <h1>My Conference 2017</h1>

      <p *ngIf="!sessions">
        <em>Loading...</em>
      </p>

      <div class="row">
        <div *ngFor="let session of sessions" class="col-md-3">
          <div class="panel panel-default session">
            <div class="panel-body">
              <p>{{session.track.name}}</p>
              <h3 class="panel-title">
                <a [routerLink]="['/sessiondetail', session.id]">{{session.title}}</a>
              </h3>
              <p *ngFor="let speaker of session.speakers">
                <em>
                  <a [routerLink]="['/speaker', speaker.id]">{{speaker.name}}</a>
                </em>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
    ```

1. Agora que o componente e o serviço de dados foram criados, abra **app.module.ts** para importar o componente DataService. Adicione o seguinte no topo para importar o modulo.

    ```typescript
    import { DataService } from './components/shared/data.service';
    ```

1. No mesmo arquivo adicione o **SessionsComponent** na parte `declarations` do **@NgModule**

1. Adicione a rota para a página de sessões no **RouterModule**

    ```typescript
    { path: 'sessions', component: SessionsComponent },
    ```

1. Adicione o **DataService** como um provedor após os imports.

    ```typescript
    providers: [DataService]
    ```

1. Finalmente, adicione o seguinte no **nav-menu.component.html** para adicionar um *link* para a lista de sessões na navegação à esquerda.

    ```html
    <li [routerLinkActive]="['link-active']">
        <a [routerLink]="['/sessions']">
            <span class='glyphicon glyphicon-th-list'></span> Sessions
        </a>
    </li>
    ```


#### Rodando a aplicação

Inicie a aplicação Web Api usando o Visual Studio ou o VS Code. Ela deve inicar em http://localhost:50069

Em outro editor ou processo, inicie a aplicação FrontEndSpa pressionando F5 ou executando `dotnet run` e sua aplicação SPA estará disponível em http://localhost:5000. Como estamos usando o Webpack com o *hot module reload*, você pode continuar fazendo alterações na aplicação Angular e ver as alterações enquanto trabalha no restante do código.

### Criando a página de detalhes da sessão

> Agora que temos uma página inicial exibindo todas as sessões, nós iremos criar uma página para exibir todos os detalhes de uma sessão específica

1. Crie o componente de detalhe da sessão

    ```bash
    ng g component sessionDetail
    ```
1. Atualize o código do componente para o seguinte

    ```typescript
    import 'rxjs/add/operator/switchMap';
    import { Component, OnInit } from '@angular/core';
    import { ActivatedRoute, ParamMap } from '@angular/router';
    import { Location }                 from '@angular/common';

    import { Session } from '../shared/model';
    import { DataService } from '../shared/data.service';

    @Component({
      selector: 'session-detail',
      templateUrl: './sessiondetail.component.html'
    })
    export class SessionDetailComponent implements OnInit {
      session: Session;

      constructor(
        private sessionService: DataService,
        private route: ActivatedRoute,
        private location: Location
      ) { }

      ngOnInit(): void {

        this.route.paramMap
          .switchMap((params: ParamMap) => this.sessionService.getSession(+params.get('id')!))
          .subscribe(session => this.session = session);
      }

      goBack() {
        this.location.back();
      }

    }
    ```

1. Atualize o template **session-detail.component.html**

    ```html
    <ol class="breadcrumb">
        <li><a (click)="goBack()" style="cursor: pointer">Back</a></li>
        <li><a [routerLink]="['/sessions']">Agenda</a></li>
        <li class="active">{{session.title}}</li>
    </ol>

    <h1>{{session.title}}</h1>
    <span class="label label-default">{{session.track.name}}</span>

    <p *ngFor="let speaker of session.speakers">
        <em>
          <a [routerLink]="['/speaker', speaker.id]">{{speaker.name}}</a>
        </em>
      </p>

    <p>{{session.abstract}}</p>
    ```

1. Adicione a rota para a página de detalhes da sessão no **RouterModule** adicionando também o parâmetro `/:id` a ser passado para a sessão específica.

    ```typescript
    { path: 'sessiondetail/:id', component: SessionDetailComponent }
    ```

### Crie a página de detalhes do palestrante

> Vamos adicionar uma página para exibir os detalhes de um determinado palestrante

1. Create the Speaker Detail component

    ```typescript
    ng g component speakerDetail
    ```

1. Atualize o código do componente para o seguinte

    ```typescript
    import 'rxjs/add/operator/switchMap';
    import { Component, OnInit } from '@angular/core';
    import { ActivatedRoute, ParamMap } from '@angular/router';
    import { Location }                 from '@angular/common';

    import { DataService } from '../shared/data.service';
    import { Speaker } from '../shared/model';

    @Component({
      selector: 'conf-speakerdetail',
      templateUrl: './speakerdetail.component.html'
    })
    export class SpeakerDetailComponent implements OnInit {
      speaker: Speaker;

      constructor(
        private dataService: DataService,
        private route: ActivatedRoute,
        private location: Location
      ) { }

      ngOnInit() {
        this.route.paramMap
        .switchMap((params: ParamMap) => this.dataService.getSpeaker(+params.get('id')!))
        .subscribe(speaker => this.speaker= speaker);
      }

      goBack() {
        this.location.back();
      }

    }
    ```

1. Atualize o template **speaker-detail.component.html** para o seguinte

    ```html
    <ol class="breadcrumb">
      <li><a (click)="goBack()" style="cursor: pointer">Back</a></li>
      <li><a [routerLink]="['/speakers']">Speakers</a></li>
      <li class="active">{{speaker.name}}</li>
    </ol>

    <h2>{{speaker.name}}</h2>

    <p>{{speaker.bio}}</p>

    <h3>Sessions</h3>
    <div class="row">
      <div class="col-md-5">
          <ul class="list-group">
            <li *ngFor="let session of speaker.sessions" class="list-group-item">
              <a [routerLink]="['/sessiondetail', session.id]">{{session.title}}</a>
            </li>
        </ul>
      </div>
    </div>
    ```
1. Adicione a rota da página de detalhes do palestrante no **RouterModule** adicionando também o parâmetro `/:id` a ser passado para sessão específica.

    ```typescript
    { path: 'speaker/:id', component: SpeakerDetailComponent }
    ```

### Desafio / Bônus

Adicione um página de listagem de palestrantes e faça um link para ela na rota `/speakerdetail`

**Anterior**: [Sessão #7 - Desafios](7.%20Challenges.md)
