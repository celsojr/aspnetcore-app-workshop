
## Crie um novo projeto usando o Visual Studio

1. Crie e adicione um novo projeto chamado `BackEnd` e dê o nome para a solução de `ConferencePlanner` usando Arquivo / Novo / ASP.NET Core Aplicação Web. Selecione o template Web API, sem Auth, sem suporte a  Docker.
   ![](images/vs2019-new-project.png "Creating a new solution in Visual Studio")
   ![](images/vs2019-name-backend-project.png "Adding a project to the solution")
   ![](images/vs2019-new-web-api.png "Web API Project settings")

   > ***Observação:* Se não estiver usando o Visual Studio, crie o novo projeto usando `dotnet new webapi` pela lina de comando, mais detalhes abaixo:**
   > 1. Crie uma pasta chamada ConferencePlanner e execute `dotnet new sln` na linha de comando para criar a solução
   > 2. Crie uma sub pasta chamada BackEnd e crie o projeto usando `dotnet new webapi` na linha de comando dentro da pasta BackEnd
   > 3. Adicione o projeto à solução usando `dotnet sln add BackEnd/BackEnd.csproj`
1. Adicione uma nova pasta `Models` na pasta raiz da aplicação.
1. Adicione uma nova classe `Speaker` usando o seguinte trecho de código:
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.ComponentModel.DataAnnotations;
    using System.Linq;
    using System.Threading.Tasks;

    namespace BackEnd.Models
    {
        public class Speaker
        {
           public int Id { get; set; }

           [Required]
           [StringLength(200)]
           public string Name { get; set; }

           [StringLength(4000)]
           public string Bio { get; set; }

           [StringLength(1000)]
           public virtual string WebSite { get; set; }
        }
    }
    ```
1. Adicione uma referência para o pacote Nuget `Microsoft.EntityFrameworkCore.SqlServer` version `3.0.0`.
    > Isso pode ser feito usando a linha de comando `dotnet add package Microsoft.EntityFrameworkCore.SqlServer --version 3.0.0`
1. Adicione uma referência para o pacote Nuget `Microsoft.EntityFrameworkCore.Sqlite` version `3.0.0`.
    > Isso pode ser feito usando a linha de comando `dotnet add package Microsoft.EntityFrameworkCore.Sqlite --version 3.0.0`
1. A seguir nós iremos criar um novo DbContext para o Entity Framework. Crie uma nova classe `ApplicationDbContext` na pasta `Models` usando o seguinte código:
    ```csharp
    using Microsoft.EntityFrameworkCore;

    namespace BackEnd.Models
    {
        public class ApplicationDbContext : DbContext
        {
            public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
                : base(options)
            {

            }

            public DbSet<Speaker> Speakers { get; set; }
        }
    }

    ```
1. Adicione uma string de conexão no arquivo appsettings.json para esse banco de dados:

    ```json
   {
     "ConnectionStrings": {
       "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=aspnet-BackEnd-931E56BD-86CB-4A96-BD99-2C6A6ABB0829;Trusted_Connection=True;MultipleActiveResultSets=true"
     },
     "Logging": {
       "LogLevel": {
         "Default": "Warning",
         "Microsoft": "Warning",
         "Microsoft.Hosting.Lifetime": "Information"
       }
     },
     "AllowedHosts": "*"
   }
    ```

## Registrando o serviço DB Context
1. Adicione o seguinte código no topo do método `ConfigureServices()` em `Startup.cs`:
    ```csharp
    services.AddDbContext<ApplicationDbContext>(options =>
    {
        if (RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
        {
            options.UseSqlServer(Configuration.GetConnectionString("DefaultConnection"));
        }
        else
        {
            options.UseSqlite("Data Source=conferences.db");
        }
    });
    ```
    > Esse código registra o serviço `ApplicationDbContext` para que ele possa ser injetado nos controllers. Além disso, ele configura tecnologias específicas de banco de dados de acordo com o sistema operacional e strings de conexão.

## Configurando EF Migrations

1. Adicione uma referência para o pacote Nuget `Microsoft.EntityFrameworkCore.Tools` version `3.0.0`.
    > **Se você não estiver usando o Visual Studio** instale via linha de comando com `dotnet add package Microsoft.EntityFrameworkCore.Tools --version 3.0.0`

1. Add a reference to the NuGet package `Microsoft.EntityFrameworkCore.Tools` version `3.0.0`.
    > **If you're not using Visual Studio** install the package from the command line with `dotnet add package Microsoft.EntityFrameworkCore.Tools --version 3.0.0`

### Visual Studio: Package Manager Console 

1. No Visual Studio, Selecione Ferramentas -> NuGet Package Manager -> Package Manager Console

1. Execute os seguintes comandos no console do gerenciador de pacotes
   ```console
   Add-Migration Initial
   Update-Database
   ```

### Linha de Comando

1. Instale o global tool do EntityFramework `dotnet-ef` usando o segunte comando:
   ```console
   dotnet tool install -g dotnet-ef --version 3.0.0
   ```

1. Abra o prompt de comando e navegue até o diretório do projeto. (O diretório contendo o arquivo `Startup.cs`).

1. Execute os seguintes comandos no prompt de comando:
    ```console
    dotnet build
    dotnet ef migrations add Initial
    dotnet ef database update
    ```
Comandos explicados

| Comando       |Descrição       |
| ------------- |-------------|
| `dotnet ef migrations add Initial` / `Add-Migration Initial`    | gera código para criar o schema de banco de dados inicial baseado no modelo especificado no 'ApplicationDbContext.cs'. `Initial` é o nome da migração.  |  
|`dotnet ef database update` / `Update-Database` | cria o banco de dados      |

  >Para mais informações sobre esses comandos e scaffolding em geral, acesse [este tutorial](https://docs.microsoft.com/en-us/aspnet/core/tutorials/first-mvc-app/adding-model#add-initial-migration-and-update-the-database).

  >Se por acaso o seu banco de dados retornar um estado inconsistente e você quiser resetar as coisas, você pode usar `dotnet ef database drop` seguido de `dotnet ef database update` para remover o seu banco de dados e executar todas as migrações novamente.

## Uma olhada rápida no Values Controller
Primeiro, abra a pasta `Controllers` e veja rapidamente o `ValuesController`. Você verá funções simples que correspondem aos verbos HTTP. Você verá os retornos deste controller daqui a pouco, mas primeiro criaremos nosso próprio API controller para a classe de modelo `Speakers`.

## Fazendo o scaffolding de uma API Controller
### Usando o Visual Studio
1. Clique com o botão direito do mouse na pasta `Controllers` e escolha Add/Controller. Selecione "API Controller with actions, using Entity Framework".

1. No caixa de seleção, escolha o modelo `Speaker` para o Model Class, `ApplicationDbContext` para o "Data Context Class" e clique no botão `Add`.
   ![](images/scaffold-api-controller.png)

### Usando a linha de comando
1. Instale o pacote "Microsoft.VisualStudio.Web.CodeGeneration.Design"
    ```console
    dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design --version 3.0.0
    ```

1. Instale a ferramenta global `aspnet-codegenerator` executando o seguinte comando:
    ```console
    dotnet tool install -g dotnet-aspnet-codegenerator --version 3.0.0
    ```

> Nota: você precisará fechar e reabrir a janela do console para poder usar esta ferramenta.
2. Na pasta do projeto, na linha de comando, execute o seguinte comando:

    ```console
    dotnet aspnet-codegenerator controller -api -name SpeakersController -m Speaker -dc BackEnd.Models.ApplicationDbContext -outDir Controllers
    ```

## Testando a API usando o Swashbuckle

Nesta seção, adicionaremos documentação à nossa API usando o pacote Swashbuckle NuGet.

[Swashbuckle.AspNetCore](https://github.com/domaindrivendev/swashbuckle.aspnetcore) é um projeto de código aberto para gerar documentos Swagger para APIs da Web criadas com o ASP.NET Core.

[Swagger](https://swagger.io) é uma representação legível por máquina de uma API RESTful que permite suporte para documentação interativa, geração de SDK do cliente e descoberta.

Informações adicionais sobre o uso do Swashbuckle no ASP.NET Core estão disponíveis neste tutorial: [ASP.NET Web API Help Pages using Swagger](https://docs.microsoft.com/en-us/aspnet/core/tutorials/web-api-help-pages-using-swagger)

1. Adicione uma referência para o pacote Nuget `Swashbuckle.AspNetCore` version `5.0.0-rc4`.
    > Isso pode ser feito via linha de comando usando `dotnet add package Swashbuckle.AspNetCore --version 5.0.0-rc4`

1. Adicione o serviço Swashbuckle no seus método `ConfigureServices`:
    ```csharp
    services.AddControllers();

    services.AddSwaggerGen(options =>
        options.SwaggerDoc("v1", new OpenApiInfo { Title = "Conference Planner API", Version = "v1" })
    );
    ```
1. Configure o Swashbuckle adicionando as seguintes linhas logo antes de `UseRouting` no método `Configure` em `Startup.cs`:
    ```csharp
    app.UseSwagger();

    app.UseSwaggerUI(options =>
        options.SwaggerEndpoint("/swagger/v1/swagger.json", "Conference Planner API v1")
    );
    ```
    > ***Nota:*  Devido à forma como o middleware e o pipeline estão estruturados, você deve colocá-lo antes da declaração  `app.UseEndpoints()`.**
1. Adicione um redirecionamento ao final do pipeline que aponta para o endpoint do swagger.
   ```csharp
   app.Run(context =>
   {
       context.Response.Redirect("/swagger");
       return Task.CompletedTask;
   });
   ```

1. Execute a aplicação (F5 no Visual Studio ou `dotnet run` no console).
1. Navegue para a UI do Swagger em `http://localhost:<random_port>/swagger`.
    ![](images/swagger-speakers.png)
1. Primeiro, clique no botão *GET* na sessão *Values*. Você vai os valores que foram listados no `ValuesController` anteriormente.
1. Na sessão *Speakers*, clique no botão *GET*. Você vai ver que não há palestrantes sendo retornados. Vamos adicionar um!
1. Na sessão *Speakers*, clique no botão *POST*. Referenciando o exemplo a direita, preencha uma requisição para o palestrante. Deixe o `ID` em branco, isso será definido pelo banco de dados.
    ![](images/swagger-create-speaker.png)
    ```json
    {
      "name": "Tyrion Lannister",
      "bio": "Drinks and knows things",
      "webSite": "http://giphy.com/search/tyrion-lannister"
    }
    ```
1. Quando você clicar no botão *Try it out!*, você deve ver uma resposta de sucesso do servidor. Agora, clicando no botão *GET* acima, deve exibir o palestrante recém cadastrado.
    ![](images/swagger-create-results.png)

**Próximo**: [Sessão #2 - Back-end](2.%20Build%20out%20BackEnd%20and%20Refactor.md)
